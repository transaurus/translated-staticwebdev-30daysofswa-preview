---
slug: devtools-ado
title: "#17: Multi-Stage Deploy with ADO"
authors: [anthony]
tags: [swa, 30days, dev-tools]
draft: false 
---

<head>
  <meta name="twitter:url" content="https://www.azurestaticwebapps.dev/blog/devtools-ado" />
  <meta name="twitter:title" content="#17: Multi-Stage Deployments With Azure DevOps" />
  <meta name="twitter:description" content="Join @nthonyChu on #30DaysOfSWA as he walks us through multi-stage deployments of @AzureStaticApps using @AzureDevOps - with @PlaywrightWeb testing integrated!" />
  <meta name="twitter:image" content="https://www.azurestaticwebapps.dev/assets/images/17-banner-2d8ecefdc1683370295255b3fa8a0df3.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:creator" content="@nitya" />
  <meta name="twitter:site" content="@AzureStaticApps" /> 
  <link rel="canonical" href="https://techcommunity.microsoft.com/t5/apps-on-azure-blog/multi-stage-azure-static-web-apps-deployments-with-azure-devops/ba-p/3390625" />
</head>

欢迎来到 **#30DaysOfSWA** 的 `第3周第3天`!!

:::info[来自 Microsoft 技术社区]
请访问 **[Apps On Azure](https://techcommunity.microsoft.com/t5/apps-on-azure-blog/multi-stage-azure-static-web-apps-deployments-with-azure-devops/ba-p/3390625)** 技术社区博客查看本文的权威版本，以及其他关于 **[Web Apps](https://techcommunity.microsoft.com/t5/apps-on-azure-blog/bg-p/AppsonAzureBlog/label-name/Web%20Apps)** 主题的文章。
:::

## 我们将涵盖的内容

* 构建包含 Azure Functions API 和 Playwright 测试的 SWA
 * 将 SWA 部署到暂存环境
 * 使用 Playwright 自动验证暂存应用
 * 等待手动批准
 * 部署到生产环境
 * **练习。** 探索 [演示应用程序源代码](https://github.com/anthonychu/swa-devops-pipeline-demo) 并尝试运行！

![](../static/img/series/17-banner.png)

Azure Static Web Apps 最近新增了自动配置 Azure DevOps 流水线以构建和部署应用的功能。这是快速启动和运行应用的绝佳方式。

<iframe width="560" height="315" src="https://www.youtube.com/embed/4JkfeZp7aDk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

对于生产应用程序，通常会在部署到生产环境之前先将应用部署到暂存环境。本文将介绍如何配置一个强大的 Azure DevOps 流水线，该流水线将：

- 构建应用、Azure Functions API 和 Playwright 测试
- 将应用部署到暂存环境
- 使用 Playwright 测试自动验证暂存应用
- 等待手动批准
- 将应用部署到生产环境

## 示例应用程序

我们将使用一个 .NET 6 全栈应用程序。

- 前端：Blazor WebAssembly
- 后端：Azure Functions
- 测试：Playwright

要跟随操作，请将存储库导入到您的 Azure DevOps 项目中。您可以对 Node.js 应用程序使用类似的步骤。

:::info[**源代码可用**]
查看代码：**[@anthonychu/swa-devops-pipeline-demo](https://github.com/anthonychu/swa-devops-pipeline-demo)**。
:::

## 创建静态 Web 应用和部署流水线

最近，Azure Static Web Apps 新增了 [生成 Azure DevOps 流水线](https://docs.microsoft.com/azure/static-web-apps/get-started-portal?pivots=azure-devops) 以部署应用的功能。

您可以在一个步骤中创建静态 Web 应用和部署流水线。

1. 在 Azure 门户中，搜索并创建一个新的静态 Web 应用。

1. 在创建过程中，选择 "Azure DevOps" 作为部署源，并选择包含应用的 DevOps 存储库和分支。

    ![使用 Azure DevOps 创建应用](https://user-images.githubusercontent.com/3982077/168908827-22dd512a-cec7-4e27-aca4-993428f2a03e.png)

1. 在构建预设中，选择 "Blazor"。这将预填充应用和 API 文件夹位置。

    ![选择 Blazor 预设](https://user-images.githubusercontent.com/3982077/168909032-b817a631-6e74-4739-8c4a-1ff480f955a3.png)

创建应用时，存储库中将生成一个新的流水线 YAML 文件。它将自动运行。构建和部署应用需要几分钟时间。

![生成的构建流水线 YAML 文件的位置](https://user-images.githubusercontent.com/3982077/168909383-0d275e2f-15ae-40e8-aa2d-56a208f7a6f4.png)

在浏览器或本地编辑器中打开流水线 YAML 文件查看其内容。该文件包含一个自动构建和部署应用的 `AzureStaticWebApp` 任务。

## 创建 Azure Pipelines 环境

Azure Pipelines 允许您定义环境。环境可用于为流水线添加手动审批环节。

我们将创建两个环境——暂存(Staging)和生产(Production)，它们将对应我们要部署的两个 Azure Static Web Apps 环境。

要创建流水线环境，请在 Pipelines 下选择"Environments"。

![打开环境](https://user-images.githubusercontent.com/3982077/168909775-61e3e243-c298-4fcf-a5ba-8af0a94a7a5d.png)

创建一个名为"暂存(Staging)"的环境。由于此阶段不需要手动审批，您无需进行其他配置。

接着创建一个名为"生产(Production)"的新环境。由于我们需要在部署到生产环境前进行手动审批，您可以配置该环境要求手动审批。

1. 在环境的"Approvals and checks"中，选择"Approvals"。
1. 添加自己作为审批人并创建审批策略。

![创建审批策略](https://user-images.githubusercontent.com/3982077/168910157-d32f767f-c608-4047-b0f5-66b7e4beb2f2.png)

稍后更新的流水线将引用这些环境。

## 通过密码保护 Azure Static Web Apps 环境

Azure Static Web Apps 提供预览环境，让您可以在部署到生产环境前测试应用。

预览环境最初是为 GitHub 中的拉取请求提供的。最近，Static Web Apps 引入了定义[命名预览环境](https://docs.microsoft.com/azure/static-web-apps/named-environments)的功能。例如，我们可以创建一个名为"暂存(Staging)"的环境。

预览环境默认是公开的。这对开源项目很有利，但有时我们希望保护它们不被公开访问。

您可以为应用的预览环境添加密码保护。

1. 在 Azure 门户中打开您的静态 Web 应用
1. 在"配置"中选择"常规设置"选项卡
1. 选择"仅保护暂存环境"并输入密码
    ![仅保护暂存环境](https://user-images.githubusercontent.com/3982077/168910485-02aacade-3961-41fd-aa9c-54cd14df5aab.png)

您也可以选择保护所有环境。但在本应用中，我们希望生产环境对公众开放。

## 配置多阶段流水线

现在我们已经配置好了 Azure Pipelines 环境和密码保护，可以配置流水线了。

在浏览器或本地编辑器中打开流水线 YAML 文件，将其内容替换为[此文件](https://github.com/anthonychu/swa-devops-pipeline-demo/blob/main/azure-pipelines.yml)的内容。

我们将逐步介绍流水线的不同部分。它有3个主要阶段：构建应用、部署到暂存环境、部署到生产环境。

### 阶段1：构建应用

```yaml
trigger:
- main

pool:
  vmImage: ubuntu-latest

stages:

- stage: Build

  jobs:
  - job: build
    displayName: Build app

    steps:
    
    - task: UseDotNet@2
      displayName: Install .NET SDK
      inputs:
        packageType: 'sdk'
        version: '6.0.x'
        
    - script: |    
        dotnet publish -c Release -o "$(Build.ArtifactStagingDirectory)/frontend"
      displayName: Build Blazor frontend
      workingDirectory: $(System.DefaultWorkingDirectory)/Client
      
    - script: |  
        dotnet publish -c Release -o "$(Build.ArtifactStagingDirectory)/api"
      displayName: Build Azure Functions API
      workingDirectory: $(System.DefaultWorkingDirectory)/Api
      
    - script: |
        dotnet build -c Release -o "$(Build.ArtifactStagingDirectory)/tests"
      displayName: Build Playwright tests
      workingDirectory: $(System.DefaultWorkingDirectory)/PlaywrightTests

    - task: PublishBuildArtifacts@1
      displayName: Publish artifacts
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
```

流水线在`main`分支发生任何更改时触发。如果您的应用使用其他分支，可以修改此设置。

流水线随后会构建应用、Azure Functions API 和 Playwright 测试，然后输出构件。相同的构建构件会被部署到所有环境。这确保您在其他环境中测试的应用与部署到生产环境的是同一个版本。

### 阶段2：部署到暂存环境并运行 Playwright 测试

```yaml
- stage: deploy_staging
  displayName: Deploy to staging

  jobs:
    - deployment: deploy
      displayName: Deploy and test
      environment: Staging
      variables:
      # Change the variable group name to match the one in the generated pipeline
      - group: Azure-Static-Web-Apps-calm-coast-0df39b910-variable-group
      strategy:
        runOnce:
          deploy:
            steps:

            - download: none
            - checkout: none

            - task: DownloadBuildArtifacts@1
              displayName: Download artifacts
              inputs:
                buildType: current
                downloadType: single
                artifactName: drop
                downloadPath: $(System.ArtifactsDirectory)

            - task: AzureStaticWebApp@0
              displayName: Deploy to staging environment
              inputs:
                app_location: frontend/wwwroot
                api_location: api
                skip_app_build: true
                skip_api_build: true
                verbose: true
                azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_CALM_COAST_0DF39B910)
                deployment_environment: staging
                workingDirectory: $(System.ArtifactsDirectory)/drop

            - task: UseDotNet@2
              displayName: Install .NET SDK
              inputs:
                packageType: 'sdk'
                version: '6.0.x'

            - script: |
                chmod -R a+x $(System.ArtifactsDirectory)/drop/tests
                sudo --preserve-env=PLAYWRIGHT_BROWSERS_PATH pwsh $(System.ArtifactsDirectory)/drop/tests/playwright.ps1 install --with-deps chromium
                dotnet test $(System.ArtifactsDirectory)/drop/tests/PlaywrightTests.dll --logger trx
              displayName: Run Playwright tests on staging app
              env:
                PLAYWRIGHT_BROWSERS_PATH: $(Build.SourcesDirectory)/browsers
                LOGIN_PASSWORD: $(LOGIN_PASSWORD)
            
            - task: PublishTestResults@2
              condition: succeededOrFailed()
              inputs:
                testRunner: VSTest
                testResultsFiles: '**/*.trx'
```

这是最复杂的阶段。请注意，它引用了我们在Azure Pipeline中创建的"Staging"环境，同时还引用了静态Web应用首次创建时自动生成的变量组。请将其名称修改为与生成管道中的变量组相匹配。

该阶段首先从构建阶段下载构件。

接着使用`AzureStaticWebApp`任务将应用部署到暂存环境。

- `skip_app_build`和`skip_api_build`设为`true`，因为应用和API构件已预先构建完成
- `deployment_environment`设为`staging`以指定部署到暂存环境

应用部署完成后，管道会安装.NET SDK并运行安装Playwright所需依赖项的脚本。Playwright是一个可在浏览器中自动运行测试的测试框架。

依赖项安装完成后，脚本使用`dotnet test`命令运行Playwright测试。

需要注意的是，我们必须配置名为`LOGIN_PASSWORD`的机密变量。这是用户登录暂存环境时需输入的密码，Playwright测试将使用该密码在暂存环境中执行测试登录。

该阶段的最后一步是发布测试结果。

### 阶段3：部署到生产环境

```yaml
- stage: deploy_production
  displayName: Deploy to production

  jobs:
  - deployment: deploy
    displayName: Deploy
    environment: Production
    variables:
    # Change the variable group name to match the one in the generated pipeline
    - group: Azure-Static-Web-Apps-calm-coast-0df39b910-variable-group
    strategy:
      runOnce:
        deploy:
          steps:
          - download: none
          - checkout: none

          - task: DownloadBuildArtifacts@1
            displayName: Download artifacts
            inputs:
              buildType: current
              downloadType: single
              artifactName: drop
              downloadPath: $(System.ArtifactsDirectory)

          - task: AzureStaticWebApp@0
            displayName: Deploy to production environment
            inputs:
              app_location: frontend/wwwroot
              api_location: api
              skip_app_build: true
              skip_api_build: true
              verbose: true
              azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN_CALM_COAST_0DF39B910)
              workingDirectory: $(System.ArtifactsDirectory)/drop
```

此阶段引用Azure Pipeline中的"Production"环境。由于我们配置了该环境需要审批，运行此阶段前将触发人工审批步骤。

与前一阶段类似，此阶段下载构件后通过`AzureStaticWebApp`任务部署。此次未设置`deployment_environment`，因为我们要部署到静态Web应用的生产环境。

## 运行多阶段管道

管道配置完成后，保存文件即可运行。若在本地编辑，请记得推送到Azure DevOps代码库。

"部署到暂存"阶段运行后，您将看到Playwright测试已执行验证暂存环境，并发布了测试结果。

![测试结果](https://user-images.githubusercontent.com/3982077/168911185-3eea2e66-0aaf-4a86-af65-956618abc6d3.png)

管道运行将暂停，因为"部署到生产"阶段需要审批。

![审批步骤](https://user-images.githubusercontent.com/3982077/168912243-6450a5fa-6e95-4ac8-8f65-b1a7bc8d3e6b.png)

审批通过后，管道将重新运行。

审批完成后，应用即部署至生产环境。

## 深入解析

在结束本文前，我们将更深入地探讨静态Web应用环境和Playwright测试。

### Azure静态Web应用环境

在Azure门户中点击静态Web应用的"环境"标签页，即可查看已创建的生产和暂存环境。

![静态Web应用环境](https://user-images.githubusercontent.com/3982077/168911293-571d1057-c36b-4ff2-88df-3cdf20154318.png)

### Playwright测试

Playwright测试位于`PlaywrightTests`项目中，使用C#编写。

[Playwright](https://playwright.dev) 可用于通过真实浏览器自动化测试 Web 应用。示例中的测试使用 Chrome（Chromium），但 Playwright 也支持 Firefox、WebKit 和 Microsoft Edge。

这是一个用 C# 编写的 Playwright 测试示例。它引导浏览器访问应用主页，点击"获取数据"链接，并确认数据从后端 API 成功获取并渲染。

```csharp
[Test]
public async Task ShouldLoadWeather()
{
    await using var browser = await Playwright.Chromium.LaunchAsync();
    var page = await browser.NewPageAsync();
    await GoToHomePage(page);

    await page.ClickAsync("a[href='fetchdata']");

    var h1 = await page.QuerySelectorAsync("div#app main h1");
    var h1Text = h1 == null ? "" : await h1.TextContentAsync();
    Assert.AreEqual("Weather forecast", h1Text);

    var rowsSelector = "div#app main table tbody tr";
    // wait for table to have rows
    await page.WaitForFunctionAsync($"document.querySelectorAll('{rowsSelector}').length");
    var rows = await page.QuerySelectorAllAsync(rowsSelector);
    Assert.AreEqual(5, rows.Count);
}
```

测试使用 `AZURESTATICWEBAPP_STATIC_WEB_APP_URL` 环境变量来确定要测试的应用 URL。在 Azure Pipeline 中，该变量由 Azure Static Web Apps 任务在成功部署后设置。由于测试在部署到暂存环境后的流水线中运行，该变量包含暂存 Static Web Apps 环境的 URL。

测试中另一个有趣的方面是以下用于导航到主页的代码：

```csharp
private async Task GoToHomePage(IPage page)
{
    await page.GotoAsync($"{siteBaseUrl}/");
    var homePageLocatorTask = page.Locator("text=Hello, world!").WaitForAsync();
    var passwordPageLocatorTask = page.Locator("text=Password protected").WaitForAsync();
    var isPasswordPage = (await Task.WhenAny(homePageLocatorTask, passwordPageLocatorTask)) == passwordPageLocatorTask;

    if (isPasswordPage)
    {
        System.Console.WriteLine("Found password page, logging in...");
        var passwordInput = await page.QuerySelectorAsync("input[type=password]");
        if (passwordInput == null)
        {
            throw new Exception("Could not find password input");
        }
        await passwordInput.TypeAsync(sitePassword);
        await page.ClickAsync("button");
        await page.Locator("text=Hello, world!").WaitForAsync();
    }
}
```

如果浏览器会话未认证，此代码会自动登录到暂存环境。在运行时，`sitePassword` 变量被设置为 `LOGIN_PASSWORD` 密钥变量的值。

## 总结

随着命名预览环境和自动流水线生成等功能的加入，现在可以配置复杂、健壮的流水线，用于从 Azure DevOps 构建和部署到 Azure Static Web Apps。

---

## 练习

演示使用了一个 .NET 6 全栈应用，包含 Blazor WebAssembly 前端、Azure Functions 后端和集成的 Playwright 测试。

* 探索[此处源代码](https://github.com/anthonychu/swa-devops-pipeline-demo)。
 * 将仓库导入到你的 Azure DevOps 项目并按照教程操作。

## 资源

* [视频](https://youtu.be/4JkfeZp7aDk)：使用 Azure DevOps 和 SWA 进行多环境部署
* 演示的[仓库](https://github.com/anthonychu/swa-devops-pipeline-demo)源代码