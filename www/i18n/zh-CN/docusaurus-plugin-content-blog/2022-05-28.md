---
slug: practices-cosmosdb
title: "#27: Video Conf with ACS & SWA"
authors: [david]
tags: [swa, 30days, best-practices]
draft: false
---

欢迎来到 **#30DaysOfSWA** 的第4周第6天！！

在本周早先的示例中，我们通过KlipTok的实际案例研究了Azure静态Web应用如何与_多个_后端服务集成，以提供理想的用户体验。今天我们将探讨另一个端到端开发工作流的优秀示例——这次的重点是构建一个功能丰富的视频会议Web应用体验。让我们学习如何通过**结合Azure静态Web应用、Azure Functions、Azure CosmosDB以及Azure通信服务(ACS)**的工作流来实现这一目标。

## 内容概览

* 什么是Azure通信服务(ACS)？
 * 视频会议认证工作流
    - 使用Azure静态Web应用实现社交认证
    - 使用Azure CosmosDB存储ACS身份信息
    - 使用Azure Functions映射社交认证到ACS身份
 * 静态Web应用——托管元宇宙？🤯
 * **实践练习** 按照分步教程自行部署示例

![](../static/img/series/27-banner.png)

## 什么是Azure通信服务(ACS)？

[Azure通信服务(ACS)](https://docs.microsoft.com/en-us/azure/communication-services/overview)是一套**丰富的通信、视频和短信API**，可在任何设备、任何平台上部署您的应用程序。如果您希望在现有应用中集成电子邮件、聊天、音频/视频会议、电话或短信功能，这项服务正适合您。您可以将其视为构建自定义版Microsoft Teams的基础组件，它使用相同的基础架构。这项[CPaaS](https://www.forbes.com/advisor/business/software/what-is-cpaas/)（通信平台即服务）将为您管理服务的扩展性、质量和可用性。该平台还构建在我们安全合规的云基础之上。

观看这段短视频快速了解👇🏼

当然，这项服务是收费的。您可以通过访问 [Azure通信服务定价 | Microsoft Azure](https://azure.microsoft.com/en-us/pricing/details/communication-services/)查看各项服务的费用。

ACS通过多种SDK提供其服务： [Azure通信服务 – 示例和工具](https://github.com/Azure/communication)支持 JavaScript、 .NET、 Java、 Android、 iOS 和 Python 开发者。

您还可以选择在ACS UI库之上使用： [概述 – Page ⋅ Storybook](https://azure.github.io/communication-ui-library/?path=/story/overview--page)，它包含基于React的组件，实现了 [Microsoft Fluent Design](https://developer.microsoft.com/fluentui/) ，帮助您构建视觉上吸引人的Web应用。融合所有这些概念的最佳示例是**[群组通话英雄示例 – Azure通信服务示例概述](https://docs.microsoft.com/en-us/azure/communication-services/samples/calling-hero-sample?pivots=platform-web)**。

为了让您有个大致了解，观看这段2分钟的视频教程，了解如何获取内部ACS认证令牌以连接其基础架构。然后我可以通过简单的网页和ACS JavaScript SDK加入现有的Teams会议：

**想在家跟着做吗？** 您只需：

* [在Azure门户中创建Azure通信服务资源](https://docs.microsoft.com/en-us/azure/communication-services/quickstarts/create-communication-resource?tabs=windows&pivots=platform-azp) 
  * 访问 https://aka.ms/acsquicktest 并按照上面的视频教程操作。

您会发现，默认情况下，Azure通信服务提供了基本的认证和身份层。但您需要在此基础上连接自己的身份平台。接下来，我们看看如何实现这一点！

## 使用Azure Function、CosmosDB和静态Web应用构建认证层

### 1. Azure Static Web Apps - 社交身份验证

实际上，SWA 提供了开箱即用的出色身份验证体验。要了解更多信息，请阅读：[Azure Static Web Apps 的身份验证和授权](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-authorization?tabs=invitations)。无需编写任何额外代码，几秒钟内即可获得现成的身份验证层！

我们将使用它作为前端来欢迎并验证用户身份。

### 2. Azure Functions - 映射到 ACS 身份标识

然后，我们将通过 Azure Function 将他们的社交账户身份与内部 ACS 身份标识进行映射。Azure Function 会将映射存储在一个小型 CosmosDB 表中。流程如下：

首先，您会进入一个页面，要求选择您喜欢的社交登录提供商：

![静态 Web 应用示例的截图，显示 Twitter、Github、Microsoft 和 Google 的 logo](../static/img/series/w4d6/ACSSWA001.jpg)

认证通过后，您将直接连接到 Azure 通信服务基础设施。无需生成令牌或其他操作，Azure Function 已为您处理。例如，在此截图中我使用了我的 Twitter 账户：

![认证后的静态 Web 应用示例截图，显示网络摄像头已激活](../static/img/series/w4d6/ACSSWA002.jpg)

您可以看到 UI 显示了我的 Twitter 账户 *davrous@twitter* 如何映射到内部 ACS 用户 ID *8:acs:4ba98fcc*...当然正常情况下您不应该向用户显示这些信息 😉。

通过这种方式，您可以立即呼叫朋友和同事，或仅通过使用他们的社交账户电子邮件地址作为呼叫对象来加入 Teams 会议。

### 3. Azure Functions + CosmosDB 绑定

让我们看看实现此场景的 Azure Function 代码。首先，您可以在 [function.json 文件](https://github.com/davrous/acsauth/blob/main/api/users/function.json) 中看到我使用了 CosmosDB 绑定功能。要了解更多关于此功能的信息：

-	[Azure Functions 2.x 及更高版本的 Azure Cosmos DB 输入绑定](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-cosmosdb-v2-input?tabs=in-process%2Cfunctionsv2&pivots=programming-language-javascript)
-	[Azure Functions 2.x 及更高版本的 Azure Cosmos DB 输出绑定](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-cosmosdb-v2-output?tabs=in-process%2Cfunctionsv2&pivots=programming-language-csharp)

简而言之，通过在 *function.json* 文件中进行简单声明，您就可以在 Azure Function 代码中免费获得一个简单的数据访问层。

如果您查看我的 json 文件，我定义了一个路由 *users/{email}/{lookup:bool?}*，它将在我的 Azure Function 中暴露为两个函数：*setUser* 作为输出绑定（用于写入或更新 CosmosDB）和 *getUser* 作为输入绑定（用于从 CosmosDB 读取）。

在此声明文件中，我还要求 Azure Function 使用名为“*ACS*”的 CosmosDB 数据库和名为“*users*”的表，并使用“*email*”参数作为分区键。

*getUser* 将被调用时带有一个必需的参数，即与 ACS 内部身份标识关联的电子邮件地址。它还有一个可选的布尔参数。这要求 Azure Function 执行一个简单的解析查询，以返回与电子邮件地址关联的内部 ACS ID。当您希望通过仅提供某人的电子邮件地址（而不是必须知道其以 *8:acs:xxx* 开头的内部 ACS 身份标识）来在 ACS 上呼叫某人时，这非常有用。

*setUser* 只是创建新记录或更新现有记录。

你可以在以下位置找到Azure Function的完整源代码：[acsauth/index.ts at main · davrous/acsauth (github.com)](https://github.com/davrous/acsauth/blob/main/api/users/index.ts)。

第一个代码块实现了前文所述的解析逻辑。第二个代码块首先检查用户是否已存在于CosmosDB表中且ACS令牌是否仍有效（ACS令牌有效期仅为24小时）。若用户不存在或令牌过期，则调用ACS JavaScript SDK创建新身份标识及认证令牌，并将其与电子邮件地址建立映射。

若需了解ACS身份标识相关概念，请参阅：

- [身份模型 - Azure通信服务概念](https://docs.microsoft.com/en-us/azure/communication-services/concepts/identity-model)
- [快速入门：创建和管理访问令牌 - Azure通信服务指南](https://docs.microsoft.com/en-us/azure/communication-services/quickstarts/access-tokens?pivots=programming-language-javascript)

### 4. CosmosDB - 存储ACS身份数据

现在通过Azure Portal查看CosmosDB表中的存储内容：

![Azure门户中CosmosDB模块显示表内容的截图](../static/img/series/w4d6/ACSSWA003.jpg)

表中包含本场景所需的所有信息：

- **id**: 来自社交网络的电子邮件地址，作为分区键和查询主键
- **userId**: 关联的ACS内部身份标识（格式为8:acs:xxxx）
- **userToken**: 连接ACS基础设施所需的认证令牌
- **expiresOn**: ACS认证令牌的过期时间

Azure Function绑定功能的精妙之处在于：无需编写任何代码即可实现记录的读写操作，甚至能自动更新现有记录。

仅用少量代码，我就在ACS之上构建了身份映射层。结合Static Web App开箱即用的认证功能，甚至无需编写社交账号认证代码！

## 托管元宇宙的静态Web应用？🤯

在上述架构基础上，我使用开源WebGL引擎[Babylon.js](https://www.babylonjs.com)构建了小型元宇宙场景（本人也是该项目的贡献者）。核心逻辑与前文所述完全一致。

通过SWA用社交账号认证用户后，可直接在3D场景中发起与其他ACS用户或Teams成员的视频通话。在3D环境中进行这一切显然更酷炫，不是吗？

![加载博物馆3D场景的静态Web应用截图](../static/img/series/w4d6/ACSSWA004.jpg)

更精彩的是：得益于原生WebXR支持，你可用VR设备体验这个Babylon.js场景！参考这段视频——我使用Valve Index头显与女友Teams通话，共同虚拟参观博物馆。

若对WebXR感兴趣，可参阅我的专题文章（含多个示例项目）：[从游戏到元宇宙：用Babylon.js构建WebXR应用 – David Rousset (davrous.com)](https://www.davrous.com/2022/04/12/from-gaming-to-metaverses-building-webxr-apps-with-babylon-js/)。

## 实践练习

若您想体验并学习这个融合了ACS、SWA、Azure Function、CosmosDB和Babylon.js的示例项目，只需**不到10分钟**即可完成部署——按照关联仓库中的分步教程操作：[davrous/acsauth: 10分钟内部署Azure通信服务示例，与同事朋友共享测试](https://github.com/davrous/acsauth)。

祝您探索愉快，元宇宙里见！😊