---
slug: configuring-swa
title: "#04: Configuring SWA"
authors: [joseph, nitya]
tags: [swa, 30days, core-concepts]
draft: false
---

欢迎来到 **#30DaysOfSWA** 的 `第1周第4天`！

过去两天我们了解了Azure静态Web应用服务如何设置默认CI/CD操作（用于自动化构建/部署工作流），并在设置过程中以最小输入透明配置应用访问API。但如果我们想_自定义_构建流程或应用行为呢？这就需要掌握SWA的_配置选项_。

## 今日要点

* 配置：概念与文件
 * 自定义：应用行为
 * 自定义：构建流程
 * 自定义：环境设置
 * **实践：** 通过开源应用观察实际配置
 * **资源：** 深度学习链接

![](../static/img/series/04-banner.png)

## 概念与文件

配置静态Web应用时，我们可针对三个层面进行自定义：

* **应用层**：使用`staticwebapp.config.json`文件（位于`app_location`指定目录）定义路由、身份验证、网络等行为规则
 * **构建层**：通过GitHub Actions或Azure Pipelines的YAML文件（如`.github/workflows/azure-static-web-apps-xxx.yml`）自动化构建/部署流程
 * **环境层**：运行时才确定的配置值（如数据库连接字符串）可通过环境变量设置，无需修改应用代码

下面简要介绍各层配置，并附深度资源链接。参阅[示例场景](https://docs.microsoft.com/azure/static-web-apps/configuration-overview#example-scenarios)可快速定位特定场景所需的配置文件。

## 应用配置

应用行为通过`app_location`目录下的_staticwebapp.config.json_文件配置，主要属性包括：

* [**"routes"**](https://docs.microsoft.com/azure/static-web-apps/configuration#routes)：含"allowedRoles"访问规则、"redirect/rewrite"操作，以及请求("methods")/响应("headers","statusCode")属性
 * [**"navigationFallback"**](https://docs.microsoft.com/azure/static-web-apps/configuration#fallback-routes)：为客户端路由应用提供服务端回退路由
 * [**"responseOverrides"**](https://docs.microsoft.com/azure/static-web-apps/configuration#response-overrides)：自定义HTTP错误码响应
 * [**"platform"**](https://docs.microsoft.com/azure/static-web-apps/configuration#platform)：设置API运行时版本等平台配置

还包括身份验证、网络、全局头、MIME类型等配置。完整属性请参阅[文档](https://docs.microsoft.com/azure/static-web-apps/configuration#file-location)，参考[示例文件](https://docs.microsoft.com/azure/static-web-apps/configuration#example-configuration-file)了解定义方式。

```json
{
  "routes": [
    {
      "route": "/profile*",
      "allowedRoles": ["authenticated"]
    },
    {
      "route": "/admin/index.html",
      "allowedRoles": ["administrator"]
    },
    {
      "route": "/images/*",
      "headers": {
        "cache-control": "must-revalidate, max-age=15770000"
      }
    },
    {
      "route": "/api/*",
      "methods": ["GET"],
      "allowedRoles": ["registeredusers"]
    },
    {
      "route": "/api/*",
      "methods": ["PUT", "POST", "PATCH", "DELETE"],
      "allowedRoles": ["administrator"]
    },
    {
      "route": "/api/*",
      "allowedRoles": ["authenticated"]
    },
    {
      "route": "/customers/contoso*",
      "allowedRoles": ["administrator", "customers_contoso"]
    },
    {
      "route": "/login",
      "rewrite": "/.auth/login/github"
    },
    {
      "route": "/.auth/login/twitter",
      "statusCode": 404
    },
    {
      "route": "/logout",
      "redirect": "/.auth/logout"
    },
    {
      "route": "/calendar*",
      "rewrite": "/calendar.html"
    },
    {
      "route": "/specials",
      "redirect": "/deals",
      "statusCode": 301
    }
  ],
  "navigationFallback": {
    "rewrite": "index.html",
    "exclude": ["/images/*.{png,jpg,gif}", "/css/*"]
  },
  "responseOverrides": {
    "400": {
      "rewrite": "/invalid-invitation-error.html"
    },
    "401": {
      "redirect": "/login",
      "statusCode": 302
    },
    "403": {
      "rewrite": "/custom-forbidden-page.html"
    },
    "404": {
      "rewrite": "/404.html"
    }
  },
  "globalHeaders": {
    "content-security-policy": "default-src https: 'unsafe-eval' 'unsafe-inline'; object-src 'none'"
  },
  "mimeTypes": {
    ".json": "text/json"
  }
}
```

## 构建配置

Azure静态Web应用通过GitHub Actions（`.github/workflows/azure-static-web-apps-xxx.yml`）或Azure Pipelines（`azure-pipelines.yml`）驱动构建流程。

需掌握的核心设置包括：

* `app_location` - 应用程序源代码所在文件夹
 * `api_location` - API函数源代码所在文件夹
 * `output_location` - 构建文件生成目录
 * `app_build_command` - 自定义应用构建命令（适用于Node.js应用）
 * `api_build_command` - 自定义API构建命令（适用于Node.js应用）
 * `skip_app_build` - 跳过应用构建步骤的标志（若为true）
 * `skip_api_build` - 跳过API构建步骤的标志（若为true）
 * `build_timeout_in_minutes` - 默认15分钟（可自定义延长）

阅读[**此文档**](https://docs.microsoft.com/azure/static-web-apps/build-configuration?tabs=azure-devops#environment-variables)了解如何有效自定义和使用这些属性。

## 配置：环境

应用程序行为配置值可能随运行时环境变化。通过设置_环境变量_，可以将值的定义与应用程序代码中的使用解耦。我们将这些环境变量称为[**应用程序设置**](https://docs.microsoft.com/azure/static-web-apps/application-settings)，它们会被复制到暂存和生产环境。

但这些变量在哪里_定义_？这取决于开发阶段：

* **[本地开发：](https://docs.microsoft.com/azure/static-web-apps/application-settings#configure-api-application-settings-for-local-development)** 开发应用时，可使用不受GitHub跟踪的本地设置文件来避免敏感信息泄露。**Azure Functions**使用`api/local.settings.json`文件存储相关应用设置——请注意第3周我们将通过两篇专题文章介绍[**静态Web应用CLI**](https://github.com/Azure/static-web-apps-cli)使用的本地设置文件，该工具能提供更简单统一的本地开发体验。
 * [**暂存/生产环境：**](https://docs.microsoft.com/azure/static-web-apps/application-settings#configure-application-settings) 可通过[Azure门户](https://portal.azure.com/)浏览器界面或[Azure CLI](https://docs.microsoft.com/cli/azure/)（参见[`az staticwebapp appsettings`](https://docs.microsoft.com/cli/azure/staticwebapp/appsettings?view=azure-cli-latest)文档）定义和配置这些应用设置。这些设置会被加密并复制到暂存和生产环境。

在[文档](https://docs.microsoft.com/azure/static-web-apps/application-settings#configure-application-settings)中了解更多应用程序设置配置方法。

## 操作指南：视频演示

想观看应用程序行为配置的实际应用？请查看[Azure静态Web应用：技巧与窍门](https://docs.microsoft.com/shows/azure-tips-and-tricks-static-web-apps/)系列中的这两个视频。

<iframe width="560" height="315" frameborder="0"  src="https://aka.ms/docs/player?show=azure-tips-and-tricks-static-web-apps&ep=how-to-configure-routing-in-azure-static-web-apps-6-of-16--azure-tips-and-tricks-static-web-apps"></iframe>

<iframe width="560" height="315" frameborder="0" src="https://aka.ms/docs/player?show=azure-tips-and-tricks-static-web-apps&ep=how-to-configure-authorization-in-azure-static-web-apps-9-of-16--azure-tips-and-tricks-static-web-ap" ></iframe>

## 实践：探索示例项目

[SWA Bank](https://github.com/sinedied/swa-bank)是为[Web开发初学者](https://github.com/microsoft/Web-Dev-For-Beginners)课程项目开发的静态Web应用解决方案。

该项目已更新至最佳实践标准。请探索项目中的配置文件，理解它们如何定制应用程序行为和构建流程。**在第3周讨论开发者工具时重新审视该项目**，了解如何使用静态Web应用CLI（`swa`）工具配置本地设置进行开发。

## 实用资源

1. [配置概述](https://docs.microsoft.com/azure/static-web-apps/configuration-overview)
 2. [应用程序配置：staticwebapp.config.json](https://docs.microsoft.com/azure/static-web-apps/configuration)
 3. [构建配置：GitHub Actions或Pipelines YAML](https://docs.microsoft.com/azure/static-web-apps/build-configuration?tabs=github-actions)
 4. [环境配置：针对后端](https://docs.microsoft.com//azure/static-web-apps/application-settings)
 5. [配置应用程序设置](https://docs.microsoft.com/azure/static-web-apps/application-settings)
 6. [SWA Bank代码库](https://github.com/sinedied/swa-bank) - 一个用于探索学习的静态Web应用项目。