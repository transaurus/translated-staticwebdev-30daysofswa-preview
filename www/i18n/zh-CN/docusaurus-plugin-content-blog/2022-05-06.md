---
slug: securing-swa
title: "#05: Securing SWA"
authors: [mitali, nitya]
tags: [swa, 30days, core-concepts]
draft: false
---

欢迎来到 **#30DaysOfSWA** 的 `第1周第5天`！

截至目前，我们已经学习了如何构建/部署基础网页应用、添加无服务器API端点，以及为应用行为和构建工作流自定义配置设置。但我们遗漏了一个关键要素——**用户**！要为用户打造**差异化体验**，我们需要能够**识别用户身份**并**理解其在应用上下文中的角色**。随后可以利用这些信息**管理用户对应用功能的访问权限**（基于角色的授权），以及**应用对用户信息的访问权限**（认证后）。

值得庆幸的是，Azure Static Web Apps 让这一切变得相当简单。让我们一探究竟。

## 内容概览

* 如何保护SWA安全？
 * 托管式认证
 * 自定义认证
 * 管理用户角色
 * 基于角色的授权
 * 访问用户信息

![](../static/img/series/05-banner.png)

## 保护SWA安全

保护静态Web应用意味着什么？它包含三个层面：

* **识别用户身份** - 通过认证服务或提供商确认用户身份
 * **识别用户角色** - 理解用户使用应用时扮演的角色，据此定制体验
 * **管理访问权限** - 确保认证信息可被所有SWA组件无缝获取，使其能执行规则仅允许授权用户/角色访问资源

我们将深入探讨满足这些需求的三大核心概念：**认证**、**角色分配**和**基于角色的授权**。

## 托管式认证

Azure Static Web Apps 提供开箱即用的**简化认证体验**，支持：

* 预配置提供商：Twitter、GitHub、Azure Active Directory
 * 预分配角色：匿名（访客）或已认证（登录后）
 * 可定制规则：在`staticwebapps.config.json`中为路由定义

所有预配置提供商默认启用，各自拥有预定义的[登录](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-authorization?tabs=invitations#login)API端点，以及共享的[登出](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-authorization?tabs=invitations#logout)API端点。

* 需要禁用特定预配置提供商？只需[添加拦截规则](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-authorization?tabs=invitations#block-an-authentication-provider)到其登录路由即可禁止访问
 * 想要在登录成功/失败后跳转至自定义页面？使用[查询参数和路由规则](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-authorization?tabs=invitations#post-login-redirect)实现

这就是默认的_托管式认证_体验。

## 自定义认证

但如果您需要更灵活的注册流程（替代预配置提供商），或想添加新提供商（自定义提供商）呢？
这时就需要_自定义认证_功能来覆盖默认设置。

您可以[配置一个或多个自定义提供商](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-custom?tabs=aad#configure-a-custom-identity-provider)。Azure Static Web Apps **[原生支持](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-custom?tabs=apple#configure-a-custom-identity-provider)以下自定义认证方式：_Apple、Facebook、Google、Twitter、GitHub及AAD_！** 还支持配置符合[OpenID Connect](https://openid.net/connect/)标准的自定义提供商。

通过配置至少一个自定义身份提供程序，您实际上会禁用预配置的提供程序选项。要配置自定义提供程序，请将配置信息添加到`staticwebapps.config.json`文件的`auth`部分。这也是使用_应用程序设置_（环境变量）以隐私保护方式存储潜在敏感配置数据的好地方。

Azure Static Web Apps通过为[_登录_、_注销_和_用户配置文件_](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-custom?tabs=apple#authentication-callbacks)请求提供标准路由模式，以及登录/注销时自定义提供程序的[重定向URL](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-custom?tabs=apple#authentication-callbacks)，使得自定义注册变得简单。

## 用户角色

在此上下文中，您需要了解三个关键概念：

* 每个Static Web Apps用户都有一个或多个分配的角色。
 * 有2个内置角色（"anonymous"和"authenticated"）
 * 通过[邀请](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-authorization?tabs=invitations#add-a-user-to-a-role)或[函数](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-authorization?tabs=function#add-a-user-to-a-role)定义自定义角色并分配用户。

让我们快速回顾这些内容。

* 所有访问Static Web App的用户在通过预配置或自定义提供程序认证之前都处于_anonymous_角色（访客）。
 * 一旦认证，他们具有_authenticated_角色，但可以通过邀请（主动）或函数（被动）_分配自定义角色_
 * **主动邀请**可以从Azure门户配置并发送，使用用户特定于提供程序的电子邮件地址。用户现在点击邀请链接登录，自动分配该自定义角色。
 * **被动函数**将分配推迟到登录后，使用一个Azure函数，在给定认证用户详细信息后动态返回分配的角色（或多个角色）。

后一种方法提供了更大的灵活性，允许您使用函数处理程序调用另一个服务（如[Microsoft Graph](https://developer.microsoft.com/graph)）来为您做出角色分配决策。阅读[**角色管理**](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-authorization?tabs=function#role-management)了解更多细节——包括更新角色分配或从角色中移除用户的步骤。

## 基于角色的授权

一旦用户被分配了角色，基于该分配的_管理用户访问_变得简单，使用内置的[路由规则](https://docs.microsoft.com/en-us/azure/static-web-apps/configuration#routes)支持，基于每个`route`附加的**allowedRoles**属性。例如，以下配置设置（在`staticwebapps.config.json`中）将限制所有以`/profile*`开头的路由仅对_认证用户_开放。
)

```
{
  "route": "/profile*",
  "allowedRoles": ["authenticated"]
}
```

阅读更多关于[使用规则保护路由](https://docs.microsoft.com/en-us/azure/static-web-apps/configuration#securing-routes-with-roles)的内容，了解各种使用场景和配置设置以强制执行它们。

## 访问用户信息

Azure Static Web Apps无缝集成应用程序和API功能的一个好处是，[认证用户信息可以透明地访问](https://docs.microsoft.com/en-us/azure/static-web-apps/user-information?tabs=javascript)，有两种方式：

* 使用[直接访问端点](https://docs.microsoft.com/en-us/azure/static-web-apps/user-information?tabs=javascript#direct-access-endpoint)在`/.auth/me`，当用户认证时自动提供用户信息。
 * 使用[API函数](https://docs.microsoft.com/en-us/azure/static-web-apps/user-information?tabs=javascript#api-functions)通过`fetch`调用`/api/xxx`端点，其中`xxx`是您实现的返回用户信息的命名函数。

---

## 操作指南：观看视频！

更倾向于通过视频教程来理解流程？我们为您准备了[Azure技巧与窍门：静态Web应用](https://docs.microsoft.com/en-us/shows/azure-tips-and-tricks-static-web-apps/)系列视频。请查看以下内容：

<iframe  width="560" height="315" frameborder="0" src="https://aka.ms/docs/player?show=azure-tips-and-tricks-static-web-apps&ep=how-to-integrate-authentication-in-azure-static-web-apps-8-of-16--azure-tips-and-tricks-static-web-a"></iframe>

<iframe  width="560" height="315" frameborder="0" src="https://aka.ms/docs/player?show=azure-tips-and-tricks-static-web-apps&ep=how-to-configure-authorization-in-azure-static-web-apps-9-of-16--azure-tips-and-tricks-static-web-ap"></iframe>

---

## 练习：动手尝试！

现代Web应用中一个广受欢迎的功能是能够根据可识别上下文为认证用户分配自定义角色，并基于该角色调控其对应用中不同路由或功能的访问权限。**如何在静态Web应用中实现这一功能？**

这里有一份[**教程**](https://docs.microsoft.com/en-us/azure/static-web-apps/assign-roles-microsoft-graph)将指导您完成：

* 使用托管的[Azure Active Directory](https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis) API端点进行用户认证。
 * 查询[Microsoft Graph](https://developer.microsoft.com/graph)以确定其Active Directory群组成员身份。
 * 根据该成员身份分配自定义角色。

**自我挑战！**

修改`staticwebapp.config.json`文件中的应用行为，通过为特定路由指定`allowedRoles`来限制用户访问。测试当上述自定义角色被添加或从allowedRoles集合中移除时的效果。

---

## 实用资源

1. [SWA中的认证与授权](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-authorization?tabs=invitations)
2. [在SWA中访问认证用户信息](https://docs.microsoft.com/en-us/azure/static-web-apps/user-information?tabs=javascript)
3. [在SWA中实现自定义认证](https://docs.microsoft.com/en-us/azure/static-web-apps/authentication-custom?tabs=aad)
4. 教程：[使用Microsoft Graph和AAD分配自定义角色](https://docs.microsoft.com/en-us/azure/static-web-apps/assign-roles-microsoft-graph)
5. 视频系列：[Azure技巧与窍门 - 静态Web应用](https://docs.microsoft.com/en-us/shows/azure-tips-and-tricks-static-web-apps/)