---
slug: pwa-on-swa
title: "#13: Hosting PWA on Static Web Apps"
authors: [max]
tags: [swa, 30days, usage-examples]
draft: false
---

欢迎来到 **#30DaysOfSWA** 的 `第二周第六天`！

昨天我们探讨了在静态Web应用上部署Blazor应用。今天我们将继续介绍另一种适合托管在SWA上的项目类型——渐进式Web应用（PWA）。

## 内容概览

* 如何开始构建PWA？
 * 针对PWA-on-SWA的优化配置
 * 提升用户体验的高级技巧
 * **练习：**[将你的PWA部署到SWA，实现离线运行并安装](https://github.com/webmaxru/pwa-on-swa)

![](../static/img/series/13-banner.png)

## 渐进式Web应用

**渐进式Web应用（PWA）** 是通过开放网络技术逐步增强的Web前端应用，旨在根据设备可用功能提供最佳体验。获得"渐进式"称号的基础要求是应用的可安装性和离线可用性。我们跳过了"通过https提供服务"的要求，因为这已成为现代Web应用的标配。

![#30DaysOfPWA - 核心概念](../static/img/series/13-pwa-30days.jpg)

本章的#30DaysOfSWA假定您已熟悉Service Worker API基础概念及使用Workbox库自动化服务 Worker。如需了解这些技术，欢迎学习 **[#30DaysOfPWA](https://aka.ms/30DaysOfPWA)** 项目的核心概念部分（参见上方路线图），并观看 **[使用Workbox 6自动化服务Worker](https://www.youtube.com/watch?v=LILGt_pHk9M&ab_channel=NDCConferences)** 视频快速入门Workbox。

## 在Azure静态Web应用上托管PWA与"经典"应用有何不同？

渐进式Web应用本质上仍是Web前端应用，因此SWA资源的初始搭建过程相同——您已通过#30DaysOfSWA前期章节学习了各类Web应用的部署配置。但为确保您的"PWA on SWA"在线/离线时都能按预期运行并提供最佳用户体验和开发体验，可能需要特别注意以下实现细节和配置调优：

- 将服务Worker构建作为整体应用构建的一部分
- 为单页应用(SPA)场景配置HTML5路由
- 对SWA托管API应用缓存策略
- 显示自定义错误页面
- 处理PWA中的身份验证

**示例项目**

我创建了 **[PWA on SWA入门模板](https://github.com/webmaxru/pwa-on-swa)** 项目，其中实现了所有最佳实践。该应用已[托管于SWA](https://aka.ms/pwa-on-swa)如下图所示，让我们开始探索！

![SWA上的PWA入门模板](../static/img/series/13-pwa-starter.png)

**技术栈：**

- 一个由[create-react-app](https://reactjs.org/docs/create-a-new-react-app.html)工具搭建的React应用。这是一个简单的单页应用(SPA)，包含若干路由和调用API端点的功能。请注意，所述方法适用于任何Web前端应用：**基于框架**（包括自定义框架）或**原生JavaScript**。我们使用React只是为了更贴近现代前端应用开发的真实场景——在部署前需要对源代码进行某些操作（"构建应用"）。
- 由[Workbox](https://workboxjs.org)库驱动的[service worker](https://github.com/webmaxru/pwa-on-swa/blob/main/src/sw/service-worker.js)。
- 在SWA资源内创建的两个API端点——用于模拟"动态"(`/api/news`)和"保守"(`/api/archives`)数据源。

## 将Service Worker作为整体应用构建的一部分

位于应用`src/sw`文件夹中的service worker文件尚未准备好部署。我们需要：

1. 通过`workbox-build`模块[处理该文件](https://github.com/webmaxru/pwa-on-swa/blob/main/scripts/sw-build.js)，填充需要预缓存的资源（以实现离线可用性）
2. **打包**该文件
3. **选择**生产或开发模式
4. 为部署进行**代码压缩**

因此在`package.json`的`scripts`中，我们设置了`"build-sw": "node scripts/sw-build.js && npx rollup -c"`命令，用于构建service worker文件并将其复制到应用分发文件夹。

默认情况下，Azure Static Web Apps会运行`npm run build`命令来构建应用。因此别忘了在其中添加service worker构建命令。最终命令应为：

```
"build": "react-scripts build && npm run build-sw"
```

此处`react-scripts build`可能是使用您选择的框架/打包器构建应用的命令。**重要**：保持此顺序——总是在主应用构建完成后才构建service worker，因为需要扫描分发文件夹，根据您提供的[模式](https://github.com/webmaxru/pwa-on-swa/blob/main/scripts/sw-build.js#L5)列出需要预缓存的文件。

## 设置HTML5路由——针对单页应用(SPA)

为确保单页应用中的导航正确，需要"告知"Web服务器将所有导航请求重定向至`index.html`——从而运行应用并让其处理路由。在SWA中，您需要在[配置文件](https://github.com/webmaxru/pwa-on-swa/blob/main/staticwebapp.config.json)中添加如下内容：

```
"navigationFallback": {
  "rewrite": "index.html",
  "exclude": ["/images/*.{png,jpg,gif}", "/static/*"]
}
```

**最佳实践**：

- 在`navigationFallback`中尽可能多地"排除"路径——这将帮助您识别和修复"资源未找到"错误
- 不要将`staticwebapp.config.json`复制到应用分发文件夹——SWA会在应用源代码的任何位置找到该文件

对于PWA，这种回退机制多了一个层级：处理导航请求的第一道关卡是service worker。在[service-worker.js](https://github.com/webmaxru/pwa-on-swa/blob/main/src/sw/service-worker.js)中，我们需要以下配置块来实现SPA的正确路由：

```
const navHandler = createHandlerBoundToURL('/index.html');
const navigationRoute = new NavigationRoute(navHandler, {
  denylist: [
    new RegExp('^/images/'),
    new RegExp('^/static/'),
  ],
});
registerRoute(navigationRoute);
```

上述配置能确保在线和离线模式下，无论是根URL还是类似`/about`的深层链接都能正常打开。

## 显示自定义错误页面

最佳实践是创建并显示自定义错误页面（例如404 Not Found），而非使用浏览器内置页面。保持这些页面尽可能简单（不运行SPA本身）是明智之举。要设置自定义错误页面，您需要在[SWA配置](https://github.com/webmaxru/pwa-on-swa/blob/main/staticwebapp.config.json)中添加以下配置块：

```
"responseOverrides": {
  "400": {
    "rewrite": "/400.html"
  },
  "404": {
    "rewrite": "/404.html"
  }
}
```

这些页面会自动从SWA的导航回退中排除，因为这两个html文件位于应用分发文件夹中。但对于Workbox所需的显式指令——只需将这些地址添加到与HTML5导航部分相同的`denylist`中即可。

## 为SWA托管的API应用缓存策略

使用Workbox实现运行时缓存很简单：指定要"监听"和拦截的URL模式，并应用缓存策略。有[5种策略](https://developer.chrome.com/docs/workbox/modules/workbox-strategies/)可供选择，您也可以创建自定义策略。默认情况下，所有API URL都以`/api`开头。然后在[service worker](https://github.com/webmaxru/pwa-on-swa/blob/main/src/sw/service-worker.js)中，我们将添加以下代码块，为两个API端点应用不同的缓存策略：

```
registerRoute(
  ({ url }) => url.pathname.startsWith('/api/news'),
  new NetworkFirst()
);

registerRoute(
  ({ url }) => url.pathname.startsWith('/api/archives'),
  new CacheFirst()
);
```

现在，从API获取的数据在离线时也可用了！

**小练习**：打开[托管在SWA上的PWA Starter](https://aka.ms/pwa-on-swa)，在DevTools的Network选项卡中，点击"API缓存"演示区域的两个按钮。您会看到这两种策略在网络请求/响应模式上有何不同？

## 如何处理PWA中的身份验证

这里有几条**重要**规则：

1. 明确将SWA的`.auth`系统文件夹从Workbox的导航回退中排除（使用`denylist`），并且永远不要为其设置运行时缓存
2. 永远不要对用户从受限制API端点（由SWA或外部提供）获取的所有数据进行运行时缓存

**最佳实践**是永远不要预缓存，并且始终将与应用用户认证和受限制部分相关的所有URL排除在service worker的导航回退之外。[查看](https://github.com/webmaxru/pwa-on-swa/blob/main/src/sw/service-worker.js#L27)我们示例应用的最终`denylist`。

## 练习：将您的PWA部署到SWA，离线运行并安装它！

希望您已经准备好尝试一些有趣的事情来巩固今天学到的知识。

本次练习：

* [Fork PWA on SWA Starter仓库](https://github.com/webmaxru/pwa-on-swa)并使用您在#30DaysOfSWA前几章学到的技能将其部署到Azure Static Web Apps
* 打开SWA资源创建后获得的URL
* 现在，离线（断开互联网连接或在DevTools中模拟离线模式）并重新加载页面——它仍然有效！
* 使用桌面浏览器地址栏右侧的"应用可用"图标，将应用安装到您的笔记本电脑上——现在它的行为就像原生应用一样！

---

## 资源

以下是一些资源，帮助您开始渐进式Web应用的旅程：

* [Microsoft Docs上的PWA](https://aka.ms/learn-pwa)
 * [#30DaysOfPWA](https://aka.ms/30DaysOfPWA)
 * [Workbox库](https://workboxjs.org)