---
slug: practices-case-study
title: "#25: KlipTok & SWA: Case Study"
authors: [jeff]
tags: [swa, 30days, best-practices]
draft: false 
---

<head>
  <meta name="twitter:url" content="https://www.azurestaticwebapps.dev/blog/practices-case-study" />
  <meta name="twitter:title" content="#25: KlipTok.com: A SWA Case Study" />
  <meta name="twitter:description" content="Join @csharpfritz on #30DaysOfSWA and learn how he built Kliptok.com with @AzureStaticApps to make Twitch clips searchable!" />
  <meta name="twitter:image" content="https://www.azurestaticwebapps.dev/assets/images/25-banner.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:creator" content="@nitya" />
  <meta name="twitter:site" content="@AzureStaticApps" /> 
  <link rel="canonical" href="https://www.azurestaticwebapps.dev/blog/practices-case-study" />
</head>

欢迎来到 **#30DaysOfSWA** 的 `第4周第4天`！！

第4周聚焦Azure静态Web应用的最佳实践。在前两篇文章中，我们探讨了能增强和扩展已部署静态网站功能的Azure服务集成。今天，我们将以首个**案例研究**转换方向——介绍由Jeff Fritz构建、托管在Azure静态Web应用上的Twitch视频片段搜索与索引服务[KlipTok](https://kliptok.com)！

## 内容概览

* 什么是KlipTok？
 * KlipTok为何选择Azure静态应用？
 * Azure静态应用如何与Blazor协同工作？
 * **实践**：访问[KlipTok](https://kliptok.com)网站体验实际效果。

![](../static/img/series/25-banner.png)

## KlipTok让Twitch视频可搜索

[KlipTok](https://kliptok.com)是我于2019年11月在Twitch直播期间开始构建的网站。当时我希望创建一个平台，让用户能像浏览TikTok那样探索和互动他们喜爱的创作者在Twitch上的视频片段。

[Twitch](https://twitch.tv)是许多人用来观看游戏直播的平台。当直播中出现精彩瞬间时，观众可以截取最长60秒的片段与朋友分享。这些片段通常充满趣味，但往往难以被主动发现。这正是**KlipTok的使命——建立索引系统，让这些片段更广泛地触达用户**。

![KlipTok网站界面截图](../static/img/series/w4d3/kliptok-site.png)

## KlipTok如何运作？

KlipTok在后台实时监控Twitch上已注册主播的新片段并建立索引。这些片段经过转录处理后可供站内搜索。访客可以观看、点赞和评论片段，还能创建片段合集与好友分享。

<iframe width="560" height="315" src="https://www.youtube.com/embed/6uMCAHEM8Es" title="YouTube video player" frameborder="0"  allowfullscreen></iframe>

您可以通过[我的博客](https://jeffreyfritz.com/2021/04/introducing-kliptok/)阅读完整决策过程，或在上方视频中观看我于2020年11月直播构建其部分功能的实况。

经过18个月的运行，**KlipTok目前管理着近1200万条片段，索引数据总量约60GB**。您可访问实时仪表板[kliptok.com/status](https://kliptok.com/status)查看应用当前状态。

![显示近1200万片段的KlipTok仪表板截图](../static/img/series/w4d3/kliptok-dashboard.png)

## KlipTok选择Azure静态应用

我选择使用[Azure静态应用](https://docs.microsoft.com/en-us/azure/static-web-apps/overview)构建和部署KlipTok，同时展示[Blazor](https://blazor.net)在大型应用中的规模化运行能力。该方案使应用能**弹性扩展HTTP服务来传输内容**，同时通过基于WebAssembly运行的Blazor应用在浏览器端提供高性能体验。

KlipTok 还运行着第二个名为 "BackOffice" 的 [Azure Functions](https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview) 服务，负责 **同步 Twitch 视频片段** 和执行其他数据聚合任务。当新频道被添加到 KlipTok 进行监控时，BackOffice 服务会通过 [Azure 服务总线](https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview) 接收消息触发，开始将该频道的视频片段加入索引处理流程。

我们还利用这个后台函数应用创建了 [ML.NET](https://docs.microsoft.com/en-us/dotnet/machine-learning/) 机器学习模型，用于 **向用户推荐主播**。该模型基于 KlipTok 用户关注的频道数据进行训练，通过分析其他用户关注的相同频道来生成推荐。模型每天都会用新数据更新，以便为登录用户提供更精准的推荐。

根据 Twitch 的服务条款，视频内容在录制后的前 24 小时内不允许被导出平台。这意味着所有视频片段都应通过 Twitch 原生播放器进行引用和嵌入，这使得 KlipTok 无需下载存储实际视频内容。现在 KlipTok 既能提供符合 SEO 优化的内容，又能生成适配 Twitter、Facebook、LinkedIn 等社交平台的开放图谱卡片。

## KlipTok 系统架构

在使用 Blazor WebAssembly 和 Azure 静态网站时我们遇到一个小问题——搜索引擎和社交媒体平台不知道 **如何抓取和呈现 WebAssembly 生成的内容**。

为此，我们通过 [Azure Front Door](https://docs.microsoft.com/en-us/azure/frontdoor/front-door-overview) 接入了一个被戏称为"静态站点"的 Azure 应用服务。Azure Front Door 是微软新一代云内容分发网络(CDN)，让我们能利用全球分布的边缘节点实现更快更高效的内容交付。

通过为 Azure Front Door 添加识别爬虫的规则，现在可以将用户请求重定向到静态站点，使 KlipTok 能够同时提供 SEO 优化内容和适用于 Twitter、Facebook、LinkedIn 等社交平台的 [开放图谱](https://ogp.me/) 分享卡片。

![KlipTok 系统架构简化示意图](../static/img/series/w4d3/kliptok-architecture-simplified.png)

## 为什么选择 Azure 静态 Web 应用？

KlipTok 最初设计时就希望 **以极低成本运行，同时能轻松应对流量增长**。作为一名 C# 和 Blazor 开发者，这完美结合了我喜爱的技术栈——既能控制成本，又能通过处理 **海量数据集** 来展示 Blazor 的强大能力。

随着时间推移，KlipTok 的系统组件不断演进：Azure 表存储先被 MySQL 取代，后又迁移到 RavenDb；原本使用 Azure 队列通信的函数，现在大多已改用 Azure 服务总线。

这种组件迭代过程让我深入理解了其他客户如何使用 Azure，也帮助我们改进产品以提升 KlipTok 这类系统开发者的工作效率。

使用 Azure 静态 Web 应用能更轻松地集成其他 Azure 服务，这使得我可以快速调整 KlipTok 的架构和功能，及时响应需求变化。

## 天作之合：SWA 与 Blazor

作为开发者，我对 Blazor 和 Azure 静态 Web 应用的组合非常满意。构建 Blazor 应用时能确保 API 始终按需扩展，这是巨大的优势。

Blazor WebAssembly 使用 HttpClient 与服务器通信，在 Azure 静态 Web 应用中则是与 HTTP 触发的函数交互。这种模式极大简化了前端代码与后端服务的定义和交互过程。

例如：当用户点击某个剪辑的**点赞**按钮时，Blazor应用程序可以向托管函数发送消息以增加点赞数。该函数随后会更新RavenDb中的点赞计数，并通过新计数刷新UI。Blazor应用程序无需等待函数执行完成即可更新UI——只需对点赞数进行增减操作。

## 总结

KlipTok的开发过程充满乐趣，其交付历程也取得了巨大成功。我十分期待继续完善KlipTok，在扩展应用功能的同时探索并展示更多Blazor与Azure的炫酷特性。如有疑问或建议，欢迎在Twitch上联系我。

## 实践练习

* **想体验这个Azure静态Web应用的实际效果？** 立即访问[KlipTok](https://kliptok.com)并用Twitch账号登录！浏览网站后，KlipTok将开始为你推荐关注创作者的热门剪辑。
* **想尝试用Blazor构建自己的Azure静态Web应用？** 参考我的[早期博客文章](/blog/build-with-blazor#exercise-remix-fritzs-hats)，通过我的开源项目——[Fritz的炫酷帽子收藏](https://github.com/csharpfritz/Fritz.HatCollection)——来自定义、构建并部署Blazor应用到Azure静态Web应用。