---
slug: practices-cognitive-search
title: "#23: Cognitive Search & SWA"
authors: [dina]
tags: [swa, 30days, best-practices]
draft: false
---

欢迎来到 **#30DaysOfSWA** 的 `第4周第2天`！

昨天，我们以端到端开发者体验为主题开启了"最佳实践"周。其中的关键在于能够无缝集成相关工具和服务以增强用户体验，同时不增加开发工作流的复杂性。今天，我们将通过一个实践教程来具体展示这一点——将已部署的Azure静态Web应用与**Azure认知搜索**集成，只需几个步骤即可为你的Web应用添加自定义搜索功能。

## 内容概览

* 什么是Azure认知搜索？
 * 什么是搜索索引？
 * 为网站添加认知搜索功能
 * 部署到Azure静态Web应用
 * **练习**：创建自己的搜索索引并将应用部署到SWA

![](../static/img/series/23-banner.png)

## 让你的应用支持搜索！

今天我们将探讨如何使用[Azure认知搜索](https://docs.microsoft.com/en-us/azure/search/search-what-is-azure-search)为网站添加搜索功能。这是一项云搜索服务，提供基础设施、API和工具，用于为移动和Web应用构建丰富的集成搜索功能，甚至支持自定义搜索以增强默认体验。

我们将通过以下示例进行演示。想要跟随操作吗？你可以[获取源代码](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/)并在教程中同步探索。

我们将使用一个**图书目录**示例——这是网站搜索最常见的应用场景之一——来展示如何快速将该服务与已部署的Azure静态Web应用结合使用。

![集成认知搜索功能的示例](../static/img/series/w4d2/cognitive-search-enabled-book-website.png)

该示例网站提供了对10,000本图书目录的访问。用户体验流程如下：

* 用户在搜索栏输入文本进行目录搜索
 * 输入过程中，可利用搜索索引的联想功能主动补全文本
 * 查询完成后，显示包含部分详细信息的结果
 * 用户选择图书可查看存储在搜索索引中的完整详情

很简单对吧？下面我们来看看其实现原理，然后深入探讨具体实现细节。

## 什么是Azure认知搜索？

[Azure认知搜索](https://docs.microsoft.com/en-us/azure/search/search-what-is-azure-search)是一项云搜索服务，使开发者能够提供丰富的搜索体验。从架构上看，搜索服务介于包含未索引数据的外部数据存储与向搜索索引发送查询请求并处理响应的客户端应用之间。

![枯燥开发的往返路径](../static/img/series/w4d2/azure-search-diagram.svg)

认知搜索**可与其他Azure服务集成**，实现从Azure数据源自动获取/摄取数据，并通过技能集整合来自认知服务的可消费AI能力（如图像和自然语言处理），或集成你在Azure机器学习中创建的自定义AI，或封装在Azure函数中的AI逻辑。

创建Azure认知搜索资源后，可通过以下关键信息进行访问：

* **资源名称**：认知搜索实例的名称
* **索引名称**：一个资源可包含多个索引，每个索引都有可识别的名称
* **管理密钥**：用于向搜索索引上传数据
* **查询密钥**：供API在搜索索引中查找数据使用

我们多次提到"搜索索引"这个术语——它具体指什么？

## 什么是搜索索引？

搜索功能需要数据作为查询基础。在Azure认知搜索中，这些数据存储在_搜索索引_中。由于此示例已预先编写完成，它包含了将JSON数据上传至搜索索引的流程。若需从零开始构建，请参考[快速入门](https://docs.microsoft.com/en-us/azure/search/search-get-started-portal)了解如何用**您的**数据创建Azure认知搜索索引。

最复杂的环节是将数据映射到认知搜索类型。为此，您需要提供描述每个数据字段的[架构文件](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/bulk-insert/good-books-index.json)。

### 可搜索的标题字段

该图书目录架构文件中的一个字段示例是书名：

```json
{
    "name": "title",
    "type": "Edm.String",
    "facetable": false,
    "filterable": false,
    "key": false,
    "retrievable": true,
    "searchable": true,
    "sortable": false,
    "analyzer": "standard.lucene",
    "indexAnalyzer": null,
    "searchAnalyzer": null,
    "synonymMaps": [],
    "fields": []
},
```

字段**类型**为`Edm.String`，使用`standard.lucene`**分析器**。该字段支持搜索且可检索（会出现在查询结果中）。

### 按语言筛选

图书目录搜索还支持按语言筛选。这种称为分面筛选的功能由**facetable**属性实现。

```json
{
    "name": "language_code",
    "type": "Edm.String",
    "facetable": true,
    "filterable": true,
    "key": false,
    "retrievable": true,
    "searchable": false,
    "sortable": false,
    "analyzer": null,
    "indexAnalyzer": null,
    "searchAnalyzer": null,
    "synonymMaps": [],
    "fields": []
},
```

### 用户输入时建议搜索词

架构还定义了当用户在搜索框输入时，搜索索引应基于哪些字段提供**建议器**功能。本示例中，建议内容根据作者姓名和书名生成。

```json
"suggesters": [
{
    "name": "sg",
    "searchMode": "analyzingInfixMatching",
    "sourceFields": [
    "authors",
    "original_title"
    ]
}
```

创建包含数据的搜索索引后，可通过Visual Studio Code的认知搜索扩展查看数据。

![通过VS Code扩展查看的搜索索引](../static/img/series/w4d2/visual-studio-code-search-extension-view-docs.png)

## 为网站添加搜索功能

创建包含数据的搜索索引后，可通过UI添加搜索功能。您的UI将用户搜索请求传递给API，API查询搜索索引并返回结果。

[客户端代码](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/src)提供以下交互功能：

* 提供[搜索组件](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/src/components/SearchBar/SearchBar.js)
    * 当用户在搜索框输入时，通过API提供[搜索建议](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/src/components/SearchBar/Suggestions/Suggestions.js)
    * 用户选择或取消选择筛选条件（分面）时，[对结果进行筛选](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/src/components/Facets/Facets.js)
* 提供[结果组件](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/src/components/Results/Results.js)，可能包含[分页功能](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/src/components/Pager/Pager.js)

[无服务器代码](https://github.com/Azure-Samples/azure-search-javascript-samples/tree/master/search-website/api)提供以下API响应客户端请求：

* [搜索](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/api/Search/index.js)目录
* 提供[搜索建议](https://github.com/Azure-Samples/azure-search-javascript-samples/blob/master/search-website/api/Suggest/index.js)
* 获取[特定条目](https://github.com/Azure-Samples/azure-search-javascript-samples/tree/master/search-website/api/Lookup)的数据

## 部署至SWA

示例通过GitHub Action部署到SWA，该Action由Visual Studio Code的SWA扩展自动创建。

创建并部署示例后，您需要设置环境变量以从无服务器API连接到您的认知搜索资源。随后，图书目录网站即可访问并支持搜索功能。

## 练习：将数据上传至搜索索引

1. [Fork GitHub示例仓库](https://docs.microsoft.com/azure/search/tutorial-javascript-overview#fork-and-clone-the-search-sample-with-git)，并克隆到本地计算机。此步骤是必需的，因为GitHub操作需要写入您账户有访问权限的仓库。
1. [创建资源组](https://docs.microsoft.com/azure/search/tutorial-javascript-overview#create-a-resource-group-for-your-azure-resources)用于存放SWA和认知搜索资源。
1. 在Visual Studio Code中使用认知搜索扩展[创建搜索索引](https://docs.microsoft.com/azure/search/tutorial-javascript-create-load-index#create-an-azure-search-resource)。  
1. [获取管理员密钥](https://docs.microsoft.com/azure/search/tutorial-javascript-create-load-index#create-an-azure-search-resource)。
1. 在示例的bulk_insert_books.js脚本中[设置管理员密钥和资源名称](https://docs.microsoft.com/azure/search/tutorial-javascript-create-load-index#prepare-the-bulk-import-script-for-search)。
1. 不要通过git提交这些更改。您不希望这些密钥出现在公开的fork中。
1. 在`./bulk-insert`文件夹中[安装依赖项并批量插入数据](https://docs.microsoft.com/azure/search/tutorial-javascript-create-load-index#run-the-bulk-import-script-for-search)：

    ```javascript
    npm install && npm start
    ```

1. 您的搜索索引已准备就绪，可响应搜索查询。

## 练习：将SWA部署至Azure

1. 在Visual Studio Code中[创建SWA资源](https://docs.microsoft.com/azure/search/tutorial-javascript-deploy-static-web-app#create-a-static-web-app-in-visual-studio-code)。此过程会向您的fork添加一个GitHub操作YAML文件，并将该版本部署到您的SWA资源。

    此时，网站应已可访问，但搜索功能尚未连接。

1. [获取查询密钥](https://docs.microsoft.com/azure/search/tutorial-javascript-deploy-static-web-app#get-cognitive-search-query-key-in-visual-studio-code)用于您的搜索索引。您的API需要这些密钥（查询密钥和认知搜索资源名称）以通过无服务器API响应查询。
1. 在Azure门户中[设置密钥](https://docs.microsoft.com/azure/search/tutorial-javascript-deploy-static-web-app#add-configuration-settings-in-azure-portal)用于您的无服务器API。

    现在，搜索功能已从您的API连接到认知搜索索引。

1. [使用支持搜索的网站](https://docs.microsoft.com/azure/search/tutorial-javascript-deploy-static-web-app#use-search-in-your-static-web-app)查找图书。
1. 缓慢输入以查看基于您输入内容的建议。
1. 筛选不同语言的结果。
1. 选择图书以查看其所有详细信息。

## 故障排除

* 确保您在上传文件中使用了**管理员密钥**。
* 确保您在SWA配置中使用了**查询密钥**。

## 后续步骤

此网站提供了基本的图书搜索功能。通过以下方式超越基础功能：

* [拼写检查](https://docs.microsoft.com/en-us/azure/search/speller-how-to-add)
* [模糊搜索](https://docs.microsoft.com/en-us/azure/search/search-query-fuzzy)
* [语义搜索](https://docs.microsoft.com/en-us/azure/search/semantic-ranking)

这只是[Azure for JavaScript Developers](https://docs.microsoft.com/en-us/azure/developer/javascript/how-to/create-static-web-app)页面提供的众多示例之一。探索静态Web应用部分，了解可集成到现代Web应用中的其他Azure服务！