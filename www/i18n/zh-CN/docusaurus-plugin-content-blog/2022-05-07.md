---
slug: previewing-swa
title: "#06: Previewing SWA"
authors: [nitya, michail]
tags: [swa, 30days, core-concepts]
draft: false
---

欢迎来到 **#30DaysOfSWA** 的第1周第6天！！

我们即将完成第一周的学习！！🎉

截至目前，我们已经学习了如何利用_静态资产托管_(Azure Static Web Apps)和_无服务器API_(Azure Functions)功能来构建并部署一个具备可扩展性和成本效益的Web应用程序。我们还学会了如何根据需求_配置_和_保护_静态Web应用。那么还有什么需要探讨的呢？

**部署**选项？让我们开始吧！此前我们讨论的是默认体验：从_生产_分支部署，使用_GitHub_ Actions实现CI/CD。但如何在生产部署前**预览**静态Web应用？我们将探讨如何在拉取请求中预览SWA、在非生产分支预览，以及通过预配置的命名环境使我们的预发布工作流更高效。

## 今日要点

* SWA支持哪些部署类型？
 * _预览功能_：在拉取请求中
 * _预览功能_：在非生产分支
 * _预览功能_：在命名环境中
 * _部署功能_：到自定义域名
 * **实践练习:** [使用SWA预览功能审查PR](https://docs.microsoft.com/en-us/azure/static-web-apps/review-publish-pull-requests)

![](../static/img/series/06-banner.png)

## 部署类型

当我们考虑部署时，通常涉及两类环境：作为实际使用主入口的_生产环境_，以及用于内部测试和预览版早期验证的_预发布环境_。

Azure Static Web Apps 原生支持四种环境类型：

* _生产环境_：这是真实世界的部署入口，会被**搜索引擎索引**，并可关联自定义域名（若已配置）。
 * _拉取请求(PR)环境_：这是为拉取请求建立的**临时**环境，当PR关闭时会被拆除。
 * _分支环境_：这是为非生产分支建立的**长期稳定**环境，URL在该分支存续期间保持不变。
 * _命名环境_：上述环境的URL会反映PR编号或分支名称。您也可以配置具有固定名称的**稳定**预览环境，关联特定部署上下文（例如临时版本）。

生产部署的URL格式为`<默认主机名>-<编号>.azurestaticapps.net`，其中`默认主机名`对每个应用唯一。

_预览_环境的URL格式为：`<默认主机名>-<分支或环境名称>.<区域>.azurestaticapps.net`，其中`区域`反映部署地理位置，`分支或环境名称`可以是分支名、命名环境或拉取请求编号。

让我们简要了解每种类型。

## 拉取请求

当前拉取请求_预览环境_仅适用于托管在GitHub且配置了GitHub Actions的项目：

* 每个发往_受监控分支_的PR都会获得一个**临时**预发布环境，该环境在PR关闭时自动拆除。
  * 用于验证变更、执行完整性检查等
  * 如果向关联PR的分支提交新代码，环境会自动重建部署
  * 即使GitHub仓库是私有的，预览环境也_对外可见_——不过默认情况下URL不易被发现（即不被搜索引擎索引）

了解如何[在Azure Static Web Apps中预览拉取请求](https://docs.microsoft.com/en-us/azure/static-web-apps/review-publish-pull-requests)。

## 分支

分支的预览环境将拥有**稳定**的URL。在相关的_GitHub Actions_或_Azure Pipelines_工作流文件中进行配置，如[此示例所示](https://docs.microsoft.com/en-us/azure/static-web-apps/branch-environments?tabs=github-actions#example)。

例如，在GitHub Actions环境下，这涉及两个步骤：

* 将`production_branch`属性设置为要用作生产部署源的指定分支。
* 在`trigger`（Azure Pipelines）或`push: branches`（GitHub Actions）下列出所有需要创建预览环境的其他分支。

若需为所有分支提供预览环境支持，可使用通配符（GitHub Actions用`**`，Azure Pipelines用`*`）。

以下是一个GitHub Actions配置文件的示例——**生产**环境基于_main_分支构建，同时为其他指定分支（_dev_和_staging_）创建独立的**预览**环境。

了解如何[在Azure Static Web Apps中创建分支预览环境](https://docs.microsoft.com/en-us/azure/static-web-apps/branch-environments?tabs=github-actions)。

```
name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - main
      - dev
      - staging
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  build_and_deploy_job:
    ...
    name: Build and Deploy Job
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          ...
          production_branch: "main"
```

## 命名环境

有时，您可能需要一个非生产的预览环境，其URL保持**稳定**（不关联特定PR编号或分支名称），且会在配置文件中所有被跟踪分支提交时触发重建。

与分支配置类似，这需要手动修改默认配置文件（GitHub Actions或Azure Pipelines），如[此示例所示](https://docs.microsoft.com/en-us/azure/static-web-apps/named-environments?tabs=github-actions#configuration)。

在GitHub Actions场景中，步骤如下：

* 将`deployment_environment`属性（在相关构建任务中）设为此预览环境的**名称**。
* 在`push: branches`下列出与此命名环境关联的分支——这些分支的提交将触发该环境的重建和部署。

这是一个GitHub Actions配置示例——创建名为**release**的命名环境，当**任意**分支发生变更时（通过`**`通配符实现），该环境会更新并部署至类似`<DEFAULT_HOST_NAME>-release.<LOCATION>.azurestaticapps.net`的URL。

了解[Azure Static Web Apps中的命名预览环境](https://docs.microsoft.com/en-us/azure/static-web-apps/named-environments?tabs=github-actions)

```
name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - "**"
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  build_and_deploy_job:
    ...
    name: Build and Deploy Job
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          ...
          deployment_environment: "release"
```

## 自定义域名

您可能已注意到，默认部署URL（生产环境形如`XXX.azurestaticapps.net`，预览环境形如`XXX.<LOCATION>.azurestaticapps.net`）并不便于用户记忆和使用。

添加自定义域名可解决此问题。Azure Static Apps支持配置**子域名**和**根域名**！例如，对于域名`www.azure.com`，`azure.com`是根域名，`www`是相关子域名。

如何配置这些域名？您有两种选择：

* 使用**外部DNS提供商**（如果您的域名注册商支持）
* 使用**Azure DNS**（管理DNS域名，即使域名购自他处）

为保持本文简洁，我们不再详述每种选项。请根据需求参考以下链接：

* 设置根域名 - 使用 [Azure DNS](https://docs.microsoft.com/en-us/azure/static-web-apps/apex-domain-azure-dns) | 使用 [外部提供商](https://docs.microsoft.com/en-us/azure/static-web-apps/apex-domain-external)
 * 设置子域名 - 使用 [Azure DNS](https://docs.microsoft.com/en-us/azure/static-web-apps/custom-domain-azure-dns) | 使用 [外部提供商](https://docs.microsoft.com/en-us/azure/static-web-apps/custom-domain-external)

---

## 操作指南：视频演示

更喜欢通过视频了解操作流程？我们为您准备了 [Azure 技巧与窍门：静态 Web 应用](https://docs.microsoft.com/en-us/shows/azure-tips-and-tricks-static-web-apps/) 系列。观看此视频，了解如何为静态 Web 应用设置自定义域名！

<iframe   width="560" height="315" frameborder="0"  src="https://aka.ms/docs/player?show=azure-tips-and-tricks-static-web-apps&ep=how-to-set-up-a-custom-domain-name-in-azure-static-web-apps-10-of-16--azure-tips-and-tricks-static-w"></iframe>

---

## 练习：动手尝试！

**拉取请求**对于高效开展开源或多贡献者项目至关重要，因此了解 Azure 静态应用如何在合并到生产部署之前，为验证拉取请求中的变更设置**预生产**环境非常重要。

通过完成[本教程](https://docs.microsoft.com/en-us/azure/static-web-apps/review-publish-pull-requests)，在现有的 Azure 静态 Web 应用项目上获得实际操作经验。

_目前，拉取请求的分阶段预生产环境仅适用于 GitHub Actions 部署 - 因此请确保选择一个已设置默认工作流的 GitHub 托管的 SWA 项目_。

---

## 实用资源

1. [Azure 静态 Web 应用中的预览环境](https://docs.microsoft.com/en-us/azure/static-web-apps/preview-environments)
2. [拉取请求预览环境](https://docs.microsoft.com/en-us/azure/static-web-apps/review-publish-pull-requests)
3. [分支预览环境](https://docs.microsoft.com/en-us/azure/static-web-apps/branch-environments)
4. [命名预览环境](https://docs.microsoft.com/en-us/azure/static-web-apps/named-environments)
5. 视频系列：[Azure 技巧与窍门 - 静态 Web 应用](https://docs.microsoft.com/en-us/shows/azure-tips-and-tricks-static-web-apps/)
6. [关于自定义域名](https://docs.microsoft.com/en-us/azure/static-web-apps/custom-domain)