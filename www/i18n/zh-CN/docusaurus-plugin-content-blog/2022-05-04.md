---
slug: api-enabling-swa
title: "#03: API-Enabling SWA"
authors: [anthony, nitya]
tags: [swa, 30days, core-concepts]
draft: false
---

欢迎来到 **#30DaysOfSWA** 的`第1周第3天`！！

昨天，我们使用vanillaJS模板从GitHub仓库构建并部署了第一个静态Web应用。借助VS Code扩展，仅需几次点击就自动配置了GitHub Actions（CI/CD）工作流。今天，我们将学习如何通过Azure Functions为应用添加**无服务器API端点**，从而根据需求更高效地扩展API。

## 今日要点

* 为何选择SWA无服务器方案？
 * 使用Azure Functions添加API
 * 快速入门：使用托管Functions
 * 自带Functions应用
 * **示例：** 将[Azure-SWAG](https://github.com/sinedied/azure-swag/)带到5月4日！
 * **练习：** 亲自动手尝试！

![](../static/img/series/03-banner.png)

## 为何选择无服务器？

在[SWA介绍](2022-05-02.md)中，我们探讨了静态Web应用如何通过架构分离**静态内容资源**与**动态API端点**，使组件能够独立部署和扩展。

昨天的示例展示了仅含内容资源（无API）的基础静态Web应用。通过SWA部署可充分利用Azure全球分布式内容服务器实现高速低成本访问。现在我们需要添加API端点以支持客户端动态请求。那么无服务器的意义是什么？如何实现无服务器API端点？

此处的[无服务器](https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/serverless/web-app)指采用事件驱动架构按需分配计算资源。API服务器会随需求增长自动扩展，在需求下降时保持成本效益。

[Azure Functions](https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview)简化了无服务器解决方案的实现。通过动态分配计算资源运行的_function_（代码块）处理事件。API请求增加时自动扩容，需求降低时自动收缩。[**学习路径**](https://docs.microsoft.com/en-us/learn/paths/create-serverless-applications/)深入讲解Azure Functions使用。

## 使用Azure Functions

静态Web应用与Azure Functions深度集成，在安全（用户数据）和路由方面提供关键特性：

* **[用户数据访问](https://docs.microsoft.com/en-us/azure/static-web-apps/user-information?tabs=javascript#api-functions)** - API函数处理请求时可直接获取用户认证和基于角色的授权数据。
 * **[API路由访问](https://docs.microsoft.com/en-us/azure/static-web-apps/configuration?#routes)** - 应用无需自定义CORS规则即可安全访问`/api`路由。

更优越的是，SWA支持两种Azure Functions配置方式：

* **托管Functions** - 由Azure静态Web应用服务配置并管理Functions部署。
* **自带Functions** - 使用现有Azure Functions应用并自行管理部署。

免费版仅支持托管Functions方案，存在[部分限制](https://docs.microsoft.com/en-us/azure/static-web-apps/apis)——例如仅支持HTTP触发器、不兼容[持久函数](https://docs.microsoft.com/en-us/azure/azure-functions/durable/durable-functions-overview)等，但配置快捷且无缝使用。今天我们重点介绍此方案，第4周将详解[自带Functions](https://docs.microsoft.com/en-us/azure/static-web-apps/functions-bring-your-own)方案。

## 添加API

想要亲身体验如何为静态Web应用部署添加API端点吗？查看这个[快速入门](https://docs.microsoft.com/en-us/azure/static-web-apps/add-api?tabs=vanilla-javascript)教程，它基于你之前部署的vanilla-JS应用程序。关键步骤如下：

**1. 为SWA设置Azure Functions**

* 安装VS Code的[Azure Functions扩展](https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions)。
 * 打开应用程序根文件夹("/") - 创建一个"api"子文件夹。
 * 通过命令面板选择"Azure Static Web Apps: Create HTTP Function"，或在Azure扩展菜单中选择闪电图标。
 * 输入必要的配置信息（语言="JavaScript"，函数名称="message"），然后确认。

_静候设置过程完成。_ 这将在根文件夹的`/api`目录中生成配置文件(*.json)，并在`/api/message`子文件夹中包含2个文件：

* _function.json_ - 定义此函数的触发器、绑定和[其他设置](https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference?tabs=blob#function-code)。
 * _index.js_ - 实现一个异步函数（通过`/api/message`访问）。

**2. 更新index.js文件以实现你的函数** - 确保它根据传入的API请求和上下文（输入参数）返回所需的响应。

**3. 更新应用程序代码以调用API** - 你可以直接调用`fetch('/api/message')` - Azure Functions的无缝集成确保API路由自动完成。

**4. 使用SWA CLI在本地测试集成。**
Azure静态Web应用CLI（SWA CLI）是一个工具，通过模拟所需服务来支持静态Web应用的本地开发。按照[这些步骤](https://docs.microsoft.com/en-us/azure/static-web-apps/add-api?tabs=vanilla-javascript#run-the-frontend-and-api-locally)安装工具，并在本地开发环境中运行/测试你的应用和API。在第3周（"开发者工具"）的详细2部分文章中，我们将详细介绍SWA CLI的功能、配置和使用。

**5. 使用API位置更新GitHub Actions工作流**

这是确保Azure静态Web应用部署工作流也能获取新API函数的关键步骤。

* 打开你的SWA的默认GitHub Actions工作流文件，将`api_location`属性更新为"api"。
 * 保存并提交更改以触发重新构建和部署。

**想看看API的实际效果吗？** 向下滚动到`练习`部分，我们将通过一个快速活动，指导你构建并部署一个带有GitHub（SWAG）的静态Web应用，并在此过程中庆祝#星球大战日！

**更喜欢视频教程？** 查看这个[Azure静态Web应用：技巧与窍门](https://docs.microsoft.com/en-us/shows/azure-tips-and-tricks-static-web-apps/)，它从_react-starter_模板开始，逐步演示过程，并展示了使用远程[开发容器](https://code.visualstudio.com/docs/remote/create-dev-container)为Visual Studio Code进一步简化开发体验。

<iframe width="560" height="315" frameborder="0" src="https://aka.ms/docs/player?show=azure-tips-and-tricks-static-web-apps&ep=how-to-add-an-api-to-your-azure-static-web-app-7-of-16--azure-tips-and-tricks-static-web-apps"></iframe>

## 练习：SWAG！

今天是5月4日 - 星球大战日！如果我们能用我们最喜欢的星球大战语录来庆祝这一天，岂不是很好？幸运的是，[我的同事Yohan](https://www.twitter.com/sinedied)有一个很棒的[Azure-SWAG](https://dev.to/sinedied/the-easy-way-to-serverless-web-apps-and-apis-with-azure-swag-2heb)模板，它将[Unsplash](https://unsplash.com)上的图像与一组预定义的语录结合在一个API函数（"/api/quote"）中。

**于是我创建了一个[五月四日致敬版](https://github.com/nitya/may4-swag)**。这是部署后的效果。每次刷新静态Web应用时，都会从API获取新的图片和名言。

![五月四日致敬应用](../static/img/series/03-may4.png)

* 查看[代码仓库](https://github.com/nitya/may4-swag)
 * 查看[已部署的静态Web应用](https://agreeable-tree-0a216f70f.1.azurestaticapps.net/)

你的任务：按照[这些步骤](https://github.com/nitya/may4-swag#steps)复现我的项目，然后研究[index.js](https://github.com/nitya/may4-swag/blob/main/api/quote/index.js)代码了解`/api/quote`函数的实现方式，并查看[`app.js`](https://github.com/nitya/may4-swag/blob/main/app.js)代码了解该API在应用中的调用逻辑。

## 实用资源

- [静态Web应用中的API支持](https://docs.microsoft.com/zh-cn/azure/static-web-apps/apis)
- [使用托管函数添加API](https://docs.microsoft.com/zh-cn/azure/static-web-apps/add-api?tabs=vanilla-javascript)
- [自带函数](https://docs.microsoft.com/zh-cn/azure/static-web-apps/functions-bring-your-own)
- [May4-Swag演示项目](https://github.com/nitya/may4-swag)